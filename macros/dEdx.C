#if !defined(__CINT__) && !defined(__CLING__)
#include "Riostream.h"
#include "Rtypes.h"
#include "TROOT.h"
#include "TSystem.h"
#include "TH2.h"
#include "TH3.h"
#include "TF1.h"
#include "TProfile.h"
#include "TTree.h"
#include "TChain.h"
#include "TCanvas.h"
#include "TClassTable.h"
#include "TFileSet.h"
#include "TDataSetIter.h"
#include "StBFChain.h"
#include "StIOMaker.h"
void bfc (const Int_t Last, 
	  const Char_t *Chain,
	  const Char_t *infile, 
	  const Char_t *outfile, 
	  const Char_t *TreeFile);
//R__EXTERN StBFChain *chain;
#else
#define BIT(n)       (1 << (n))
#define SETBIT(n,i)  ((n) |= (1 << i))
#define CLRBIT(n,i)  ((n) &= ~(1 << i))
#define TESTBIT(n,i) ((Bool_t)(((n) & (1 << i)) != 0))
#endif
#if 0
class StBFChain;
StBFChain *chain = 0;
class TTree;
class StIOMaker;
#endif
#endif
//#define OLDdEdx
StBFChain * bfc(Int_t First, Int_t Last,const Char_t *Chain = "", // + ",Display",
	 const Char_t *infile=0, const Char_t *outfile=0, const Char_t *TreeFile=0, const Char_t *chainName=0);
StBFChain *bfc(Int_t First, const Char_t *Chain = "MC2016,20Muons,vmc,Rung.1",
 	       const Char_t *infile=0, const Char_t *outfile=0, const Char_t *TreeFile=0, const Char_t *chainName = "");
//________________________________________________________________________________
void dEdx(Int_t First, Int_t Last,
	  const char *MainFile=	"/star/data08/reco/dAuMinBias/FullField/P03ih/2003/040/st_physics_4040004_raw_0010010.event.root",
	  const char* rootFile="", Int_t mode = 2, const Char_t *year = "", const Char_t *opt = "") {
  TString Year(year);
  if (Year == "") {
    Year = "y2019";
    TString input(gSystem->BaseName(MainFile));
    TObjArray *obj = input.Tokenize("_");
    Int_t n = obj->GetSize();
    Int_t run = 0;
    for (Int_t k = 0; k < n; k++) {
      if (run = TString(obj->At(k)->GetName()).Atoi()) break;
    }
    Int_t yy = run/1000000 - 1;
    if (yy > 0 && yy < 25) {
      Year = Form("y20%02i",yy);
    }
  }
  cout << "set from  " << MainFile << "\tyear == " << Year.Data() << endl;
  if (gClassTable->GetID("TTable") < 0) {
    gSystem->Load("libTable");
  }
  if (gClassTable->GetID("StTerminateNotified") < 0) {
    gSystem->Load("libStarRoot");
  }
  gROOT->LoadMacro("bfc.C");
  TString Chain("in,dEdxY2,magF,StEvent,mysql,NoDefault,analysis");//,SkipdNdx
  if        (Year.Contains("2019")) { Chain += ",CorrZ"; // ,analysis to add OPr40 for y2019
  } else if (Year.Contains("202"))  { Chain += ",CorrZ"; // ,analysis to add OPr40 for y2020
  } else if (Year.Contains("2005")) { Chain += ",SCEbyE,OGridLeak,OShortR,OSpaceZ2,";
  } else                            { Chain += ",CorrX"; // ,analysis to add OPr40 for <= 2018
  }
  //  if (Year == "y2021" || year == "y2022") Chain += ",USE_GAIN_FROM_FILE";
  TString STAR_VERSION(gSystem->Getenv("STAR_VERSION"));
  Bool_t tfgV = kFALSE;
  if (STAR_VERSION.BeginsWith("TFG") && ! STAR_VERSION.Contains("Export") || STAR_VERSION.Contains("DEV2")) {
    tfgV = kTRUE;
    //Chain += ",quiet,TpcHitMover,OSpaceZ2,OGridLeakFull,ForcedX";
    Chain += ",quiet"; //,TpcHitMover,OSpaceZ2,OGridLeakFull,ForcedX";
    //    Chain += ",ForcedX";
    if (mode == 2) Chain += ",dEdxCalib"; // , DontSort"; //,DbV20211017"; // !!!!!!!!!!!!   check DbV
  } else {
    Chain += ",mysql,CalcdNdx";
  }
  Chain += opt;
  //  Chain += ",CMuDst,picoWrite,noHistos,noRunco,-evout"; // For PicoDst
  TString RootFile(rootFile);
  if (RootFile == "") {
    RootFile = gSystem->BaseName(MainFile);
    RootFile.ReplaceAll(".event","");
  }
  //  if (RootFile.Contains("gstar",TString::IgnoreCase) ||
  //      RootFile.Contains("hijing",TString::IgnoreCase)) Chain += ",Simu";
  chain = bfc(-1,Chain.Data(),MainFile,0,RootFile.Data());
  StdEdxY2Maker *dEdxY2 = (StdEdxY2Maker *) chain->Maker("dEdxY2"); 
  if (dEdxY2) {
    //    dEdxY2->SetDebug(3);
    Int_t tMin = 20000101;
    Int_t tMax = 20220101;
    for (Int_t y = 2000; y < 2026; y++) {
      TString Y;
      Y += y;
      //      cout << "Year = " << Year.Data() << "\tyear " << Y.Data() << endl;
      if (Year.Contains(Y)) {
	tMin = 10000*(y-1) + 1101;
	tMax = 10000* y    + 1031;
	cout << "Year for year " << Y.Data() << "\ttMin = " << tMin << "\ttMax = " << tMax << endl;
	dEdxY2->RemAttr("tMin"); dEdxY2->SetAttr("tMin",tMin);
	dEdxY2->RemAttr("tMax"); dEdxY2->SetAttr("tMax",tMax);
	dEdxY2->PrintAttr();
	break;
      }
    }
  }
  StMaker *tofCalib = chain->Maker("tofCalib");
  if (tofCalib) chain->AddAfter("tofCalib",dEdxY2);
  Int_t Mode = 0;
  // Additional cailbration modes to default in TFG : kCalibration, kGASHISTOGRAMS, kPadSelection, kAlignment
  if (! tfgV) {
    if (mode%10 == 2) SETBIT(Mode,StdEdxY2Maker::kCalibration);
    SETBIT(Mode,StdEdxY2Maker::kGASHISTOGRAMS);
    SETBIT(Mode,StdEdxY2Maker::kPadSelection); 
    SETBIT(Mode,StdEdxY2Maker::kPadSelection);
    SETBIT(Mode,StdEdxY2Maker::kAlignment);
  }
  //  if (mode%10 == 2) 
  //    SETBIT(Mode,StdEdxY2Maker::kProbabilityPlot);
  //  SETBIT(Mode,StdEdxY2Maker::kZBGX);
    if ((mode/100)%10) 
      SETBIT(Mode,StdEdxY2Maker::kDoNotCorrectdEdx);
  if ((mode/1000)%10) SETBIT(Mode,StdEdxY2Maker::kMakeTree);
  //  SETBIT(Mode,StdEdxY2Maker::kMip);
  //  SETBIT(Mode,StdEdxY2Maker::kAdcHistos);
  //  SETBIT(Mode,StdEdxY2Maker::kXYZcheck);
  //  SETBIT(Mode,StdEdxY2Maker::kV0CrossCheck);
  //  SETBIT(Mode,StdEdxY2Maker::kSpaceChargeStudy);
  //  SETBIT(Mode,StdEdxY2Maker::kCORRELATION);
  if (Mode) {
    cout << " set dEdxY2 Mode " << Mode << " =======================================" << endl;
    dEdxY2->SetMode(Mode); 
  }
  if (! gROOT->IsBatch()) dEdxY2->SetDebug(1);
  if (Last >= 0)   chain->Init();
  St_db_Maker *db = (St_db_Maker *) chain->Maker("db");
  if (db) {
    db->SetDebug(1);
#if 1 /* disable MySQl for tables under calibration */
    const Char_t *TFGTables[5] = {"TpcSecRowB", "TpcZCorrectionC", "tpcTimeDependence", 0, 0}; //"TpcPadCorrectionMDC", "TpcLengthCorrectionMDN", 0};
    for (Int_t i = 0; TFGTables[i]; i++) {
      cout << "SetFlavor(\"TFG\",\"" << TFGTables[i] << "\"); // disable MySQL" << endl; 
      db->SetFlavor("TFG",TFGTables[i]);
    }
#endif
  }
  StIOMaker *inMk = (StIOMaker *) chain->GetMaker("inputStream");
  if (inMk) {
    inMk->SetIOMode("r");
    inMk->SetBranch("histBranch",0,"0");	//deactivate all branches
    inMk->SetBranch("eventBranch",0,"0");	//deactivate all branches
    inMk->SetBranch("runcoBranch",0,"0");	//deactivate all branches
    inMk->SetBranch("dstBranch",0,"r");
  }
  if (Last <= 0) return;
  chain->EventLoop(First,Last);
}
//_________________________________________________________________________________
void dEdx(Int_t nevents=1000,
	  const char *MainFile=	"/star/data08/reco/dAuMinBias/FullField/P03ih/2003/040/st_physics_4040004_raw_0010010.event.root",
	  const char* rootFile="", Int_t mode = 2, const Char_t *year = "", const Char_t *opt = "") {
  dEdx(1,nevents,MainFile,rootFile,mode,year,opt);
}
